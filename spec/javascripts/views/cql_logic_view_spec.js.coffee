describe 'CqlLogicView', ->

  beforeEach -> 
    jasmine.getJSONFixtures().clearCache()
    @cqlMeasures = new Thorax.Models.Measure getJSONFixture('measure_data/cqltest/CMS720v0.json'), parse: true
    @universalValueSetsByOid = bonnie.valueSetsByOid
    bonnie.valueSetsByOid = getJSONFixture('/measure_data/cqltest/value_sets.json')

  afterEach ->
    bonnie.valueSetsByOid = @universalValueSetsByOid
    
  it 'proof of concept', ->
    
    population = @cqlMeasures.get('populations').first()
    populationLogicView = new Thorax.Views.CqlPopulationLogic(model: @cqlMeasures, highlightPatientDataEnabled: true, population: @population)
    populationLogicView.render()
    
    testPatients = new Thorax.Collections.Patients getJSONFixture('records/cqltest/patients.json'), parse: true
    
    results = population.calculate(testPatients.first())

    compareResults = JSON.stringify(_.map(results.get('clause_results')['MedianTimefromEDArrivaltoEDDepartureforAdmittedEDPatients'],
      (clauseResult) -> _.omit(clauseResult, 'raw')))
    
    expectedResults = '[{"statementName":"SDE Ethnicity","final":"NA"},{"statementName":"SDE Ethnicity","final":"NA"},{"statementName":"SDE Payer","final":"NA"},{"statementName":"SDE Payer","final":"NA"},{"statementName":"SDE Race","final":"NA"},{"statementName":"SDE Race","final":"NA"},{"statementName":"SDE Sex","final":"NA"},{"statementName":"SDE Sex","final":"NA"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Inpatient Encounter","final":"TRUE"},{"statementName":"Startification1","final":"NA"},{"statementName":"Startification1","final":"NA"},{"statementName":"Startification1","final":"NA"},{"statementName":"Startification1","final":"NA"},{"statementName":"Startification1","final":"NA"},{"statementName":"Startification1","final":"NA"},{"statementName":"Startification1","final":"NA"},{"statementName":"Startification1","final":"NA"},{"statementName":"Startification1","final":"NA"},{"statementName":"Stratification2","final":"NA"},{"statementName":"Stratification2","final":"NA"},{"statementName":"Stratification2","final":"NA"},{"statementName":"Stratification2","final":"NA"},{"statementName":"Stratification2","final":"NA"},{"statementName":"Stratification2","final":"NA"},{"statementName":"Stratification2","final":"NA"},{"statementName":"Stratification2","final":"NA"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"TRUE"},{"statementName":"Initial Population","final":"FALSE"},{"statementName":"Initial Population","final":"FALSE"},{"statementName":"Initial Population","final":"FALSE"},{"statementName":"Initial Population","final":"FALSE"},{"statementName":"Measure Population","final":"UNHIT"},{"statementName":"Measure Population","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"Measure Population Exclusion","final":"UNHIT"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"},{"statementName":"MeasureObservation","final":"NA"},{"statementName":"MeasureObservation","final":"NA"},{"statementName":"MeasureObservation","final":"NA"},{"statementName":"MeasureObservation","final":"NA"},{"statementName":"MeasureObservation","final":"NA"},{"statementName":"MeasureObservation","final":"NA"},{"statementName":"RelatedEDVisit","final":"NA"}]'
      
    expect(expectedResults == compareResults)


    populationLogicView.showRationale(results)
    
    expectedHtml = '↵↵↵↵<div class="cql-logic measure-viz rationale panel-group">↵  ↵    <div>↵      <div data-view-cid="view55">↵<pre class="cql-statement"><code><span data-view-cid="view56" data-define-name="Inpatient Encounter"><span data-view-cid="view57" data-ref-id="33" class="clause-true"><span data-view-cid="view58"><span data-view-cid="view59"> define "Inpatient Encounter": </span></span><span data-view-cid="view60" data-ref-id="32" class="clause-true"><span data-view-cid="view61"><span data-view-cid="view62" data-ref-id="22" class="clause-true"><span data-view-cid="view63" data-ref-id="21" class="clause-true"><span data-view-cid="view64" data-ref-id="21" class="clause-true"><span data-view-cid="view65"><span data-view-cid="view66">["Encounter, Performed": </span></span><span data-view-cid="view67"><span data-view-cid="view68"><span data-view-cid="view69">"Encounter Inpatient"</span></span></span><span data-view-cid="view70"><span data-view-cid="view71"> ]</span></span></span></span><span data-view-cid="view72"><span data-view-cid="view73"> Encounter</span></span></span></span><span data-view-cid="view74"><span data-view-cid="view75">↵		</span></span><span data-view-cid="view76" data-ref-id="31" class="clause-true"><span data-view-cid="view77"><span data-view-cid="view78">where </span></span><span data-view-cid="view79" data-ref-id="31" class="clause-true"><span data-view-cid="view80" data-ref-id="26" class="clause-true"><span data-view-cid="view81" data-ref-id="24" class="clause-true"><span data-view-cid="view82" data-ref-id="23" class="clause-true"><span data-view-cid="view83"><span data-view-cid="view84">Encounter</span></span></span><span data-view-cid="view85"><span data-view-cid="view86">.</span></span><span data-view-cid="view87" data-ref-id="24" class="clause-true"><span data-view-cid="view88"><span data-view-cid="view89">lengthOfStay</span></span></span></span><span data-view-cid="view90"><span data-view-cid="view91"> &lt;= </span></span><span data-view-cid="view92" data-ref-id="25" class="clause-true"><span data-view-cid="view93"><span data-view-cid="view94">120 days</span></span></span></span><span data-view-cid="view95"><span data-view-cid="view96">↵			and </span></span><span data-view-cid="view97" data-ref-id="30" class="clause-true"><span data-view-cid="view98" data-ref-id="28" class="clause-true"><span data-view-cid="view99" data-ref-id="27" class="clause-true"><span data-view-cid="view100"><span data-view-cid="view101">Encounter</span></span></span><span data-view-cid="view102"><span data-view-cid="view103">.</span></span><span data-view-cid="view104" data-ref-id="28" class="clause-true"><span data-view-cid="view105"><span data-view-cid="view106">relevantPeriod</span></span></span></span><span data-view-cid="view107"><span data-view-cid="view108"> ends during </span></span><span data-view-cid="view109" data-ref-id="29" class="clause-true"><span data-view-cid="view110"><span data-view-cid="view111">"Measurement Period"</span></span></span></span></span></span></span></span></span></code></pre>↵</div>↵    </div>↵  ↵    <div>↵      <div data-view-cid="view112">↵<pre class="cql-statement"><code><span data-view-cid="view113" data-define-name="Startification1"><span data-view-cid="view114" data-ref-id="42" class=""><span data-view-cid="view115"><span data-view-cid="view116"> define "Startification1": </span></span><span data-view-cid="view117" data-ref-id="41" class=""><span data-view-cid="view118"><span data-view-cid="view119" data-ref-id="35" class=""><span data-view-cid="view120" data-ref-id="34" class=""><span data-view-cid="view121"><span data-view-cid="view122"><span data-view-cid="view123">"Inpatient Encounter"</span></span></span></span><span data-view-cid="view124"><span data-view-cid="view125"> Encounter</span></span></span></span><span data-view-cid="view126"><span data-view-cid="view127"> ↵</span></span><span data-view-cid="view128" data-ref-id="40" class=""><span data-view-cid="view129"><span data-view-cid="view130">where </span></span><span data-view-cid="view131" data-ref-id="40" class=""><span data-view-cid="view132"><span data-view-cid="view133">not </span></span><span data-view-cid="view134" data-ref-id="39" class=""><span data-view-cid="view135"><span data-view-cid="view136">(</span></span><span data-view-cid="view137" data-ref-id="39" class=""><span data-view-cid="view138" data-ref-id="37" class=""><span data-view-cid="view139" data-ref-id="36" class=""><span data-view-cid="view140"><span data-view-cid="view141"> Encounter</span></span></span><span data-view-cid="view142"><span data-view-cid="view143">.</span></span><span data-view-cid="view144" data-ref-id="37" class=""><span data-view-cid="view145"><span data-view-cid="view146">principalDiagnosis</span></span></span></span><span data-view-cid="view147"><span data-view-cid="view148"> in </span></span><span data-view-cid="view149" data-ref-id="38" class=""><span data-view-cid="view150"><span data-view-cid="view151">"Psychiatric/Mental …56"><span data-view-cid="view357"> ): </span></span><span data-view-cid="view358" data-ref-id="101" class=""><span data-view-cid="view359" data-ref-id="101" class=""><span data-view-cid="view360"><span data-view-cid="view361">Last(↵    </span></span><span data-view-cid="view362" data-ref-id="100" class=""><span data-view-cid="view363"><span data-view-cid="view364" data-ref-id="88" class=""><span data-view-cid="view365" data-ref-id="87" class=""><span data-view-cid="view366" data-ref-id="87" class=""><span data-view-cid="view367"><span data-view-cid="view368">["Encounter, Performed": </span></span><span data-view-cid="view369"><span data-view-cid="view370"><span data-view-cid="view371">"Emergency Department Visit"</span></span></span><span data-view-cid="view372"><span data-view-cid="view373"> ]</span></span></span></span><span data-view-cid="view374"><span data-view-cid="view375"> ED</span></span></span></span><span data-view-cid="view376"><span data-view-cid="view377">↵      </span></span><span data-view-cid="view378" data-ref-id="95" class=""><span data-view-cid="view379"><span data-view-cid="view380">where </span></span><span data-view-cid="view381" data-ref-id="95" class=""><span data-view-cid="view382" data-ref-id="90" class=""><span data-view-cid="view383" data-ref-id="89" class=""><span data-view-cid="view384"><span data-view-cid="view385">ED</span></span></span><span data-view-cid="view386"><span data-view-cid="view387">.</span></span><span data-view-cid="view388" data-ref-id="90" class=""><span data-view-cid="view389"><span data-view-cid="view390">relevantPeriod</span></span></span></span><span data-view-cid="view391"><span data-view-cid="view392"> </span></span><span data-view-cid="view393" data-ref-id="95" class=""><span data-view-cid="view394"><span data-view-cid="view395">ends </span></span><span data-view-cid="view396" data-ref-id="94" class=""><span data-view-cid="view397"><span data-view-cid="view398">1 hour</span></span></span><span data-view-cid="view399"><span data-view-cid="view400"> or less before</span></span></span><span data-view-cid="view401"><span data-view-cid="view402"> </span></span><span data-view-cid="view403" data-ref-id="93" class=""><span data-view-cid="view404"><span data-view-cid="view405">start of </span></span><span data-view-cid="view406" data-ref-id="92" class=""><span data-view-cid="view407" data-ref-id="91" class=""><span data-view-cid="view408"><span data-view-cid="view409">Encounter</span></span></span><span data-view-cid="view410"><span data-view-cid="view411">.</span></span><span data-view-cid="view412" data-ref-id="92" class=""><span data-view-cid="view413"><span data-view-cid="view414">relevantPeriod</span></span></span></span></span></span></span><span data-view-cid="view415"><span data-view-cid="view416">↵      </span></span><span data-view-cid="view417" data-ref-id="99" class=""><span data-view-cid="view418"><span data-view-cid="view419">sort by </span></span><span data-view-cid="view420" data-ref-id="98" class=""><span data-view-cid="view421" data-ref-id="97" class=""><span data-view-cid="view422"><span data-view-cid="view423">start of </span></span><span data-view-cid="view424" data-ref-id="96" class=""><span data-view-cid="view425"><span data-view-cid="view426">relevantPeriod</span></span></span></span></span></span></span><span data-view-cid="view427"><span data-view-cid="view428">↵  )</span></span></span></span></span></span></code></pre>↵</div>↵    </div>↵  ↵    <div>↵      <div data-view-cid="view429">↵<pre class="cql-statement"><code><span data-view-cid="view430" data-define-name="MeasureObservation"><span data-view-cid="view431" data-ref-id="108" class=""><span data-view-cid="view432"><span data-view-cid="view433"> define function "MeasureObservation"("Encounter" </span></span><span data-view-cid="view434" data-ref-id="103" class=""><span data-view-cid="view435"><span data-view-cid="view436">"Encounter, Performed"</span></span></span><span data-view-cid="view437"><span data-view-cid="view438"> ): </span></span><span data-view-cid="view439" data-ref-id="107" class=""><span data-view-cid="view440" data-ref-id="107" class=""><span data-view-cid="view441"><span data-view-cid="view442">duration in minutes of </span></span><span data-view-cid="view443" data-ref-id="106" class=""><span data-view-cid="view444" data-ref-id="105" class=""><span data-view-cid="view445"><span data-view-cid="view446">"RelatedEDVisit"(</span></span><span data-view-cid="view447" data-ref-id="104" class=""><span data-view-cid="view448"><span data-view-cid="view449"> Encounter</span></span></span><span data-view-cid="view450"><span data-view-cid="view451"> )</span></span></span><span data-view-cid="view452"><span data-view-cid="view453">.</span></span><span data-view-cid="view454" data-ref-id="106" class=""><span data-view-cid="view455"><span data-view-cid="view456">locationPeriod</span></span></span></span></span></span></span></span></code></pre>↵</div>↵    </div>↵  ↵</div>↵'

    expect(expectedHtml == populationLogicView.$el.innerHTML)