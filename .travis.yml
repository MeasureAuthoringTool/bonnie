language: ruby
cache:
  - bundler
  - node_modules
sudo: required
addons:
  chrome: stable
rvm:
  - "2.4.5"
before_install:
  - "export DISPLAY=:99.0"
  - npm install -g coffeelint
  - npm install -g istanbul
  - wget http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.4.4.tgz
  - tar xzf mongodb-linux-x86_64-3.4.4.tgz
  - ${PWD}/mongodb-linux-x86_64-3.4.4/bin/mongod --version
services:
  - xvfb
bundler_args: --without test development
before_script:
  - git config --global user.email "travis@travis.ci"
  - git config --global user.name "Travis CI"
  - bundle install
  - wget http://chromedriver.storage.googleapis.com/2.44/chromedriver_linux64.zip
  - unzip chromedriver_linux64.zip -d /tmp/chromedriver
  - export PATH=$PATH:/tmp/chromedriver
  - mkdir ${PWD}/mongodb-linux-x86_64-3.4.4/data
  - ${PWD}/mongodb-linux-x86_64-3.4.4/bin/mongod --dbpath ${PWD}/mongodb-linux-x86_64-3.4.4/data --logpath ${PWD}/mongodb-linux-x86_64-3.4.4/mongodb.log --fork
script:
  - bundle exec rake teaspoon
  - bundle exec brakeman -qAzw1
  - bundle exec bundle-audit check --update --ignore CVE-2020-5267 CVE-2020-8166 CVE-2020-8164 CVE-2020-15169 CVE-2020-8163 CVE-2020-8167 CVE-2020-8165 CVE-2020-8184 CVE-2020-8161 CVE-2019-16892 CVE-2020-10663
  - bundle exec overcommit --sign
  - bundle exec overcommit --run
  - bundle exec rake test
notifications:
  email:
    recipients:
      - healthcare-ci@googlegroups.com
    on_failure: change
