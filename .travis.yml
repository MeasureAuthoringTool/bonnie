language: ruby
cache:
  - bundler
  - node_modules
sudo: required
addons:
  chrome: stable
rvm:
  - "2.4.5"
before_install:
  - curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.13.0
  - export PATH="$HOME/.yarn/bin:$PATH"
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - npm install -g coffeelint
  - npm install -g istanbul
  - npm install -g codecov
services: mongodb
bundler_args: --without test development
before_script:
  - git config --global user.email "travis@travis.ci"
  - git config --global user.name "Travis CI"
  - bundle install
  - wget http://chromedriver.storage.googleapis.com/2.44/chromedriver_linux64.zip
  - unzip chromedriver_linux64.zip -d /tmp/chromedriver
  - export PATH=$PATH:/tmp/chromedriver
script:
  - bundle exec rake teaspoon dir=cqm_specs
  - bash <(curl -s https://codecov.io/bash) -cF coffeeScript1
  - bundle exec rake teaspoon dir=helper_specs
  - bash <(curl -s https://codecov.io/bash) -cF coffeeScript2
  - bundle exec rake teaspoon dir=integration
  - bash <(curl -s https://codecov.io/bash) -cF coffeeScript3
  - bundle exec rake teaspoon dir=models
  - bash <(curl -s https://codecov.io/bash) -cF coffeeScript4
  - bundle exec rake teaspoon dir=patient_builder_tests
  - bash <(curl -s https://codecov.io/bash) -cF coffeeScript5
  - bundle exec rake teaspoon dir=production_tests
  - bash <(curl -s https://codecov.io/bash) -cF coffeeScript6
  - bundle exec rake teaspoon dir=views
  - bash <(curl -s https://codecov.io/bash) -cF coffeeScript7
  - bundle exec teaspoon spec/javascripts/cql_calculator_spec.js.coffee
  - bash <(curl -s https://codecov.io/bash) -cF coffeeScript8
  - bundle exec brakeman -qAzw1
  # - bundle exec bundle-audit check --update
  - bundle exec overcommit --sign
  - bundle exec overcommit --run
  - bundle exec rake test
  - bash <(curl -s https://codecov.io/bash) -cF ruby
  - yarn install
  - yarn audit
notifications:
  email:
    recipients:
      - healthcare-ci@googlegroups.com
    on_failure: change
